# ;; -*- mode: makefile ;-*-
# vi: set ft=make :

IAMLIVE := false
IMAGE_ADDRESS := ghcr.io/$(NAMESPACE)/$(KEY)
IMAGE_VERSION := 0.0.1-rc.6
IMAGE := $(IMAGE_ADDRESS).ops:$(IMAGE_VERSION)

TF_LOG := WARN
TF_DIR := $(ROOT)/src/tf
TF_VOLUME := /opt/tf
TF_BIND := $(TF_DIR):$(TF_VOLUME)

ops.help:
	@echo "  ops.integrate         run all linters and scanners"
	@echo "  ops.lint              ensure the codebase passes qa checks"
	@echo "  ops.scan              scan the codebase for vulnerabilities"
	@echo "  ops.shell             shell into the ops container"
	@echo ""
.PHONY: ops.help

ops.integrate: \
	ops.lint \
	ops.scan
.PHONY: ops.integrate

ops.lint: \
	 _ops.lint.tf
.PHONY: ops.lint

ops.scan: \
	_ops.scan.images \
	_ops.scan.tf
.PHONY: ops.lint

ops.shell:
	docker run --rm -it \
		-v "$(TF_BIND)" \
		$(IMAGE) \
		bash
.PHONY: ops.shell

### Private (non-interface) targets.
_ops.lint.tf: \
	_ops.lint.tf.format \
	_ops.lint.tf.check
.PHONY: _ops.lint.tf

_ops.lint.tf.format: \
	_ops.lint.tf.fmt \
	_ops.lint.tf.hcl.fmt
.PHONY: _ops.lint.tf.format

_ops.lint.tf.check: \
	_ops.lint.tf.hcl.validate \
	_ops.lint.tf.docs
.PHONY: _ops.lint.tf.check

_ops.lint.tf.docs:
	DIRS="modules"; \
	for dir in $$DIRS; do \
		docker run --rm -i \
			-v "$(TF_BIND)" \
			$(IMAGE) \
			terraform-docs \
			markdown table \
			--recursive \
			--recursive-path $$dir \
			--output-file README.md \
			$(TF_VOLUME); \
	done
.PHONY: _ops.lint.tf.docs

_ops.lint.tf.fmt:
	docker run --rm -i \
		-v "$(TF_BIND)" \
		$(IMAGE) \
		terraform fmt \
		-diff \
		-write
.PHONY: _ops.lint.fmt

_ops.lint.tf.hcl.fmt:
	docker run --rm -i \
		-v "$(TF_BIND)" \
		$(IMAGE) \
		terragrunt hcl fmt
.PHONY: _ops.lint.tf.hcl.fmt

_ops.lint.tf.hcl.validate:
	docker run --rm -i \
		-v "$(TF_BIND)" \
		$(IMAGE) \
		terragrunt hcl validate \
		--log-level $(TF_LOG);
.PHONY: _ops.lint.tf.hcl.validate

_ops.scan.images:
.PHONY: _ops.scan.images

_ops.scan.tf:
.PHONY: _ops.scan.tf
